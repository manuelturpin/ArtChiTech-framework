name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install test dependencies
        run: pip install pytest

      - name: Run Python unit tests
        run: |
          cd plugin/tests
          python3 unit/test_state_management.py
          python3 unit/test_detection.py

      - name: Run claudemd-generator tests
        run: |
          cd plugin/skills/claudemd-generator
          python3 -m pytest tests/ -v

      - name: Validate plugin structure
        run: |
          echo "Checking required files..."
          test -f plugin/.claude-plugin/plugin.json && echo "✓ plugin.json"
          test -f plugin/README.md && echo "✓ README.md"
          test -d plugin/commands && echo "✓ commands/"
          test -d plugin/agents && echo "✓ agents/"
          test -d plugin/skills && echo "✓ skills/"
          echo ""
          echo "✅ Plugin structure is valid"

      - name: Validate Markdown syntax
        run: |
          echo "Checking Markdown files..."
          ERRORS=0
          for file in plugin/commands/*.md plugin/agents/*.md; do
            if [ -f "$file" ]; then
              # Check for frontmatter
              if ! head -1 "$file" | grep -q "^---"; then
                echo "⚠ Missing frontmatter: $file"
                ERRORS=$((ERRORS+1))
              fi
            fi
          done
          if [ $ERRORS -eq 0 ]; then
            echo "✅ All Markdown files have frontmatter"
          else
            echo "❌ $ERRORS file(s) missing frontmatter"
            exit 1
          fi
